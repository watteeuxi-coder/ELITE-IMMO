"use client"

import React, { useState, useRef, useEffect } from 'react'
import { Send, Sparkles, User, BadgeCheck, Clock, FileText, Calendar } from 'lucide-react'
import { MessageBubble } from './MessageBubble'
import { cn } from '../../lib/utils'
import { useStore, Lead } from '../../store/useStore'

type ConversationStep = 'greeting' | 'name' | 'income' | 'contract' | 'guarantor' | 'entry_date' | 'complete'

export function ChatWindow({ leadId, standalone = false }: { leadId?: string; standalone?: boolean }) {
    const [input, setInput] = useState('')
    const [isThinking, setIsThinking] = useState(false)
    const [editingIndex, setEditingIndex] = useState<number | null>(null)
    const [step, setStep] = useState<ConversationStep>('greeting')
    const { leads, updateLead, activeLead: storeActiveLead } = useStore()
    const scrollRef = useRef<HTMLDivElement>(null)

    // Use provided leadId, or activeLead from store, or first lead
    const activeLead = leadId ? leads.find((l: Lead) => l.id === leadId) : (storeActiveLead ? leads.find((l: Lead) => l.id === storeActiveLead) : leads[0])

    useEffect(() => {
        if (scrollRef.current) {
            scrollRef.current.scrollTop = scrollRef.current.scrollHeight
        }
    }, [activeLead?.chatHistory])

    // Initialize conversation if empty
    useEffect(() => {
        if (activeLead && (!activeLead.chatHistory || activeLead.chatHistory.length === 0)) {
            updateLead(activeLead.id, {
                chatHistory: [{
                    role: 'ai',
                    message: "Bonjour ! Je suis l'assistant IA d'Elite-Immo. Je vais vous aider à qualifier votre dossier de location. Pour commencer, quel est votre nom complet ?"
                }]
            })
            setStep('name')
        }
    }, [activeLead?.id])

    const calculateAIScore = (lead: Partial<Lead>): number => {
        let score = 0

        // 1. Revenu > 3x loyer (base 1000€) = +40%
        if (lead.income && lead.income >= 3000) score += 40
        else if (lead.income && lead.income >= 2000) score += 20

        // 2. Contrat CDI = +30%
        if (lead.contractType === 'CDI') score += 30
        else if (lead.contractType === 'Indépendant') score += 15
        else if (lead.contractType === 'CDD') score += 10

        // 3. Garant présent = +20%
        if (lead.hasGuarantor) score += 20

        // 4. Autres infos complétées = +10%
        if (lead.name && lead.name !== 'Nouveau Prospect') score += 5
        if (lead.entryDate) score += 5

        return Math.min(score, 100)
    }

    const handleEditMessage = (index: number) => {
        const msg = activeLead.chatHistory[index]
        if (msg.role === 'user') {
            setInput(msg.message)
            setEditingIndex(index)
            // Determine step based on the index or simply reset conversation to that point
            // For simplicity in a demo, we reset the step based on how many AI messages were before it
            const previousAiMessages = activeLead.chatHistory.slice(0, index).filter((m: any) => m.role === 'ai').length
            const steps: ConversationStep[] = ['name', 'income', 'contract', 'guarantor', 'entry_date']
            setStep(steps[previousAiMessages - 1] || 'name')
        }
    }

    const handleSend = async () => {
        if (!input.trim() || !activeLead || isThinking) return

        const userMessage = { role: 'user' as const, message: input }
        let currentHistory = [...(activeLead.chatHistory || [])]

        if (editingIndex !== null) {
            // Replace the message and remove everything after it
            currentHistory = currentHistory.slice(0, editingIndex)
            setEditingIndex(null)
        }

        updateLead(activeLead.id, {
            chatHistory: [...currentHistory, userMessage]
        })

        setInput('')
        setIsThinking(true)

        // Simulate thinking delay
        await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 1000))

        let aiResponse = ''
        let nextStep: ConversationStep = step
        let leadUpdates: Partial<Lead> = {}

        const lowerInput = input.toLowerCase()

        // Robustness: Generic "I didn't understand" if input is too short or weird (demo logic)
        const isWeirdInput = input.length < 2 && step !== 'guarantor'

        if (isWeirdInput) {
            aiResponse = "Navré, je n'ai pas bien saisi. Pourriez-vous reformuler votre réponse ?"
            nextStep = step
        } else if (step === 'guarantor' && (lowerInput.includes('c\'est quoi') || lowerInput.includes('qu\'est-ce') || lowerInput.includes('comprends pas'))) {
            aiResponse = "Un garant est une personne (souvent un proche) ou un organisme (comme Visale) qui s'engage à payer votre loyer si vous ne pouvez plus le faire. C'est une sécurité très appréciée des propriétaires. En avez-vous un ?"
            nextStep = 'guarantor'
        } else {
            switch (step) {
                case 'name':
                    if (lowerInput.includes('non') || lowerInput.includes('rien')) {
                        aiResponse = "J'ai besoin de votre nom pour créer votre dossier. Quel est-il ?"
                        nextStep = 'name'
                    } else {
                        leadUpdates.name = input
                        aiResponse = `Enchanté ${input} ! C'est un plaisir de vous accompagner. Pour avancer, quel est votre revenu mensuel net moyen ?`
                        nextStep = 'income'
                    }
                    break

                case 'income':
                    const income = parseInt(input.replace(/[^\d]/g, ''))
                    if (isNaN(income) || income < 100) {
                        aiResponse = "Désolé, je n'ai pas compris le montant. Pourriez-vous me l'indiquer en chiffres (ex: 2500) ?"
                        nextStep = 'income'
                    } else {
                        leadUpdates.income = income
                        aiResponse = `C'est noté : ${income}€/mois. Quel est votre type de contrat de travail ? (CDI, CDD, Freelance...)`
                        nextStep = 'contract'
                    }
                    break

                case 'contract':
                    const contract = lowerInput.includes('cdi') ? 'CDI' :
                        lowerInput.includes('cdd') ? 'CDD' :
                            lowerInput.includes('indep') || lowerInput.includes('free') || lowerInput.includes('auto') ? 'Indépendant' : null

                    if (!contract) {
                        aiResponse = "Je n'ai pas reconnu votre type de contrat. Est-ce un CDI, CDD ou êtes-vous Indépendant ?"
                        nextStep = 'contract'
                    } else {
                        leadUpdates.contractType = contract as Lead['contractType']
                        aiResponse = "Très bien. Possédez-vous un garant physique ou une garantie de type Visale ?"
                        nextStep = 'guarantor'
                    }
                    break

                case 'guarantor':
                    const isYes = lowerInput.includes('oui') || lowerInput.includes('yes') || lowerInput.includes('visale') || lowerInput.includes('garant')
                    const isNo = lowerInput.includes('non') || lowerInput.includes('pas')

                    if (!isYes && !isNo) {
                        aiResponse = "Je n'ai pas compris si vous aviez un garant. Répondez simplement par Oui ou par Non."
                        nextStep = 'guarantor'
                    } else {
                        leadUpdates.hasGuarantor = isYes
                        aiResponse = "Parfait. Dernière question : à partir de quelle date souhaiteriez-vous emménager ?"
                        nextStep = 'entry_date'
                    }
                    break

                case 'entry_date':
                    if (input.length < 3) {
                        aiResponse = "Pourriez-vous préciser la date d'emménager souhaitée ? (ex: le 1er mars)"
                        nextStep = 'entry_date'
                    } else {
                        leadUpdates.entryDate = input
                        const tempLead = { ...activeLead, ...leadUpdates }
                        const finalScore = calculateAIScore(tempLead)
                        leadUpdates.aiScore = finalScore
                        leadUpdates.status = 'qualified'
                        aiResponse = `Félicitations ! Votre dossier est maintenant complet et a été transmis à nos agents. Votre score de fiabilité est de ${finalScore}%. ${finalScore >= 80 ? "C'est un excellent profil, nous allons le traiter en priorité !" : "Nous reviendrons vers vous très prochainement."}`
                        nextStep = 'complete'
                    }
                    break

                default:
                    aiResponse = "Votre dossier est bien enregistré. Je reste à votre écoute si vous avez des questions."
            }
        }

        const aiMessage = { role: 'ai' as const, message: aiResponse }

        // Update score in real-time even if not finished
        const currentLeadState = { ...activeLead, ...leadUpdates }
        leadUpdates.aiScore = calculateAIScore(currentLeadState)

        updateLead(activeLead.id, {
            ...leadUpdates,
            chatHistory: [...currentHistory, userMessage, aiMessage]
        })

        setStep(nextStep)
        setIsThinking(false)
    }

    const handleContractButton = (contractType: 'CDI' | 'CDD' | 'Indépendant') => {
        if (!activeLead || step !== 'contract') return

        const userMessage = { role: 'user' as const, message: contractType }
        const updatedHistory = [...(activeLead.chatHistory || []), userMessage]

        const aiMessage = { role: 'ai' as const, message: "Merci. Avez-vous un garant ?" }

        updateLead(activeLead.id, {
            contractType,
            chatHistory: [...updatedHistory, aiMessage]
        })

        setStep('guarantor')
    }

    if (!activeLead) return (
        <div className="flex-1 flex items-center justify-center text-muted-foreground">
            Sélectionnez un prospect pour démarrer la qualification.
        </div>
    )

    return (
        <div className={cn("flex-1 flex overflow-hidden h-full", standalone ? "flex-col" : "gap-6")}>
            {/* Chat Pane */}
            <div className={cn("flex flex-col overflow-hidden", standalone ? "flex-1" : "flex-[1.5] glass rounded-3xl")}>
                {!standalone && (
                    <div className="p-6 border-b border-border bg-white/50 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold">
                                {activeLead?.name?.[0] || 'P'}
                            </div>
                            <div>
                                <h3 className="font-bold text-foreground">{activeLead?.name || 'Prospect'}</h3>
                                <p className="text-xs text-muted-foreground flex items-center gap-1">
                                    <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse" />
                                    {step === 'complete' ? 'Qualification terminée' : 'Qualification en cours'}
                                </p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 px-3 py-1.5 bg-primary/10 rounded-full">
                            <Sparkles className="w-3.5 h-3.5 text-primary" />
                            <span className="text-[10px] font-bold text-primary uppercase tracking-wider">IA Assist</span>
                        </div>
                    </div>
                )}

                <div className="flex-1 overflow-y-auto p-6 space-y-2" ref={scrollRef}>
                    {activeLead?.chatHistory?.map((msg: { role: 'user' | 'ai', message: string }, i: number) => (
                        <MessageBubble key={i} {...msg} onEdit={() => msg.role === 'user' ? handleEditMessage(i) : undefined} />
                    ))}
                    {isThinking && (
                        <div className="flex items-start gap-3 animate-pulse">
                            <div className="w-8 h-8 rounded-full bg-secondary flex items-center justify-center shrink-0">
                                <Sparkles className="w-4 h-4 text-[#7084FF]" />
                            </div>
                            <div className="bg-secondary/40 px-4 py-3 rounded-2xl text-xs text-muted-foreground flex gap-1">
                                <span className="animate-bounce">.</span>
                                <span className="animate-bounce [animation-delay:0.2s]">.</span>
                                <span className="animate-bounce [animation-delay:0.4s]">.</span>
                            </div>
                        </div>
                    )}
                </div>

                <div className="p-6 bg-white/50 border-t border-border">
                    {step === 'contract' && (
                        <div className="flex gap-2 mb-4">
                            <button
                                onClick={() => handleContractButton('CDI')}
                                className="flex-1 py-3 px-4 bg-white border-2 border-primary/20 hover:border-primary hover:bg-primary/5 rounded-2xl font-bold text-primary transition-all"
                            >
                                CDI
                            </button>
                            <button
                                onClick={() => handleContractButton('CDD')}
                                className="flex-1 py-3 px-4 bg-white border-2 border-primary/20 hover:border-primary hover:bg-primary/5 rounded-2xl font-bold text-primary transition-all"
                            >
                                CDD
                            </button>
                            <button
                                onClick={() => handleContractButton('Indépendant')}
                                className="flex-1 py-3 px-4 bg-white border-2 border-primary/20 hover:border-primary hover:bg-primary/5 rounded-2xl font-bold text-primary transition-all"
                            >
                                Indépendant
                            </button>
                        </div>
                    )}

                    {step === 'guarantor' && (
                        <div className="flex gap-2 mb-4">
                            <button
                                onClick={() => handleGuarantorButton('Oui')}
                                className="flex-1 py-3 px-4 bg-white border-2 border-primary/20 hover:border-primary hover:bg-primary/5 rounded-2xl font-bold text-primary transition-all"
                            >
                                ✓ Oui
                            </button>
                            <button
                                onClick={() => handleGuarantorButton('Non')}
                                className="flex-1 py-3 px-4 bg-white border-2 border-primary/20 hover:border-primary hover:bg-primary/5 rounded-2xl font-bold text-primary transition-all"
                            >
                                ✗ Non
                            </button>
                        </div>
                    )}

                    <div className="relative">
                        <input
                            type="text"
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && handleSend()}
                            placeholder={editingIndex !== null ? "Modifiez votre message..." : "Votre réponse..."}
                            className="w-full pr-12 pl-4 py-3 border-2 border-border bg-white/80 rounded-2xl focus:outline-none focus:border-primary transition-all placeholder:text-muted-foreground/50 text-sm font-medium"
                            disabled={isThinking}
                        />
                        <button
                            onClick={handleSend}
                            disabled={!input.trim() || isThinking}
                            className="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-primary text-white rounded-xl flex items-center justify-center shadow-lg shadow-primary/20 disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105 active:scale-95 transition-all"
                        >
                            <Send className="w-4 h-4" />
                        </button>
                    </div>
                </div>
            </div>

            {/* Data Pane - Hidden in standalone mode */}
            {!standalone && activeLead && (
                <div className="flex-1 glass p-6 rounded-3xl overflow-y-auto">
                    <h3 className="text-lg font-bold text-foreground mb-6 flex items-center gap-2">
                        <FileText className="w-5 h-5 text-primary" />
                        Données Extraites
                    </h3>
                    <div className="space-y-4">
                        <div className="p-4 bg-white/50 rounded-2xl border border-border/50">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-xs text-muted-foreground font-medium flex items-center gap-2">
                                    <User className="w-3.5 h-3.5" />
                                    Nom complet
                                </span>
                                {activeLead.name && activeLead.name !== 'Nouveau Prospect' && (
                                    <BadgeCheck className="w-4 h-4 text-green-500" />
                                )}
                            </div>
                            <p className="text-sm font-bold text-foreground">
                                {activeLead.name || '—'}
                            </p>
                        </div>

                        <div className="p-4 bg-white/50 rounded-2xl border border-border/50">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-xs text-muted-foreground font-medium">Revenus mensuels</span>
                                {activeLead.income > 0 && <BadgeCheck className="w-4 h-4 text-green-500" />}
                            </div>
                            <p className="text-sm font-bold text-foreground">
                                {activeLead.income > 0 ? `${activeLead.income}€/mois` : '—'}
                            </p>
                        </div>

                        <div className="p-4 bg-white/50 rounded-2xl border border-border/50">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-xs text-muted-foreground font-medium">Type de contrat</span>
                                {activeLead.contractType && <BadgeCheck className="w-4 h-4 text-green-500" />}
                            </div>
                            <p className="text-sm font-bold text-foreground">
                                {activeLead.contractType || '—'}
                            </p>
                        </div>

                        <div className="p-4 bg-white/50 rounded-2xl border border-border/50">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-xs text-muted-foreground font-medium">Garant</span>
                                {activeLead.hasGuarantor !== undefined && <BadgeCheck className="w-4 h-4 text-green-500" />}
                            </div>
                            <p className="text-sm font-bold text-foreground">
                                {activeLead.hasGuarantor === true ? 'Oui' : activeLead.hasGuarantor === false ? 'Non' : '—'}
                            </p>
                        </div>

                        <div className="p-4 bg-white/50 rounded-2xl border border-border/50">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-xs text-muted-foreground font-medium flex items-center gap-2">
                                    <Calendar className="w-3.5 h-3.5" />
                                    Date d'emménagement
                                </span>
                                {activeLead.entryDate && <BadgeCheck className="w-4 h-4 text-green-500" />}
                            </div>
                            <p className="text-sm font-bold text-foreground">
                                {activeLead.entryDate || '—'}
                            </p>
                        </div>

                        <div className="mt-6 p-4 bg-gradient-to-br from-primary/10 to-primary/5 rounded-2xl border border-primary/20">
                            <div className="flex items-center justify-between">
                                <span className="text-xs font-bold text-primary uppercase tracking-wider">Score IA</span>
                                <Sparkles className="w-4 h-4 text-primary" />
                            </div>
                            <div className="mt-3">
                                <div className="flex items-end gap-2 mb-2">
                                    <span className="text-3xl font-bold text-primary">{activeLead.aiScore}</span>
                                    <span className="text-lg font-bold text-primary/60 mb-1">/100</span>
                                </div>
                                <div className="w-full h-2 bg-white/50 rounded-full overflow-hidden">
                                    <div
                                        className="h-full bg-gradient-to-r from-primary to-[#9D4EDD] rounded-full transition-all duration-1000"
                                        style={{ width: `${activeLead.aiScore}%` }}
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    )
}

                </div >

    <div className="p-6 bg-white/50 border-t border-border">
        {step === 'contract' && (
            <div className="flex gap-2 mb-4">
                <button
                    onClick={() => handleContractButton('CDI')}
                    className="flex-1 py-3 px-4 bg-white border-2 border-primary/20 hover:border-primary hover:bg-primary/5 rounded-2xl font-bold text-primary transition-all"
                >
                    CDI
                </button>
                <button
                    onClick={() => handleContractButton('CDD')}
                    className="flex-1 py-3 px-4 bg-white border-2 border-primary/20 hover:border-primary hover:bg-primary/5 rounded-2xl font-bold text-primary transition-all"
                >
                    CDD
                </button>
                <button
                    onClick={() => handleContractButton('Indépendant')}
                    className="flex-1 py-3 px-4 bg-white border-2 border-primary/20 hover:border-primary hover:bg-primary/5 rounded-2xl font-bold text-primary transition-all"
                >
                    Indépendant
                </button>
            </div>
        )}
        <div className="relative">
            <input
                type="text"
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                placeholder={step === 'complete' ? 'Conversation terminée' : 'Tapez votre réponse...'}
                disabled={step === 'complete'}
                className="w-full pl-5 pr-14 py-4 bg-white border-2 border-border rounded-2xl focus:outline-none focus:ring-2 focus:ring-[#7084FF]/20 focus:border-[#7084FF] transition-all shadow-sm disabled:opacity-50 text-foreground"
            />
            <button
                onClick={handleSend}
                disabled={step === 'complete'}
                className="absolute right-2 top-1/2 -translate-y-1/2 p-2.5 bg-[#7084FF] text-white rounded-xl hover:bg-[#7084FF]/90 transition-all shadow-lg shadow-[#7084FF]/20 disabled:opacity-50"
            >
                <Send className="w-5 h-5" />
            </button>
        </div>
    </div>
            </div >

    {/* Extraction/Score Pane */ }
    < div className = "flex-1 flex flex-col gap-6" >
                <div className="glass p-6 rounded-3xl space-y-6">
                    <div className="flex items-center justify-between">
                        <h3 className="font-bold text-foreground flex items-center gap-2">
                            <BadgeCheck className="w-5 h-5 text-primary" />
                            Score de Fiabilité
                        </h3>
                        <span className="text-2xl font-black text-primary">{activeLead.aiScore}%</span>
                    </div>

                    <div className="w-full h-2 bg-secondary rounded-full overflow-hidden">
                        <div
                            className="h-full bg-primary transition-all duration-1000"
                            style={{ width: `${activeLead.aiScore}%` }}
                        />
                    </div>
                </div>

                <div className="glass p-6 rounded-3xl flex-1 space-y-6">
                    <h3 className="font-bold text-foreground flex items-center gap-2">
                        <FileText className="w-5 h-5 text-primary" />
                        Données Extraites
                    </h3>

                    <div className="space-y-4">
                        {[
                            { label: 'Revenu Mensuel', value: `${activeLead.income}€`, icon: Clock, filled: activeLead.income > 0 },
                            { label: 'Type de Contrat', value: activeLead.contractType, icon: User, filled: !!activeLead.contractType },
                            { label: 'Date d\'Entrée', value: activeLead.entryDate, icon: Calendar, filled: !!activeLead.entryDate },
                            { label: 'Garantie / Garant', value: activeLead.hasGuarantor ? 'Oui' : 'Non précisé', icon: BadgeCheck, filled: activeLead.hasGuarantor },
                        ].map((item, i) => (
                            <div key={i} className={cn(
                                "p-4 rounded-2xl border transition-all duration-300",
                                item.filled ? "bg-white border-primary/20 shadow-sm" : "bg-secondary/30 border-dashed border-border opacity-50"
                            )}>
                                <p className="text-[10px] font-bold text-muted-foreground uppercase mb-1">{item.label}</p>
                                <div className="flex items-center justify-between">
                                    <span className="font-bold text-foreground">{item.value}</span>
                                    {item.filled && <BadgeCheck className="w-4 h-4 text-green-500 fill-green-50" />}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div >
        </div >
    )
}
